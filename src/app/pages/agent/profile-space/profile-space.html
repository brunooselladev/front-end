<div class="app-page">
  <app-navbar></app-navbar>

  <div class="app-page__body">
    <app-sidebar></app-sidebar>

    <div class="app-page__content">
      <div class="page-header">
        <h1 class="page-header__title">{{ pageTitle }}</h1>
      </div>

      <div class="page-main">
        <!-- Formulario del espacio -->
        
        <div class="w-full">
          <div class="form-header">
            <h2 class="text-xl font-bold  text-gray-600 tracking-wide" style="font-family: 'Poppins', sans-serif;">
              {{ formTitle }}
            </h2>
            <button
              type="button"
              (click)="toggleFormLock()"
              class="form-header__lock-button"
              [title]="isFormLocked ? 'Desbloquear formulario' : 'Bloquear formulario'">
              <svg *ngIf="isFormLocked" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
              </svg>
              <svg *ngIf="!isFormLocked" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>
              </svg>
            </button>
          </div>
          <!-- Loading state -->
          <app-loading-overlay
            *ngIf="isLoadingData"
            [message]="'Cargando datos del espacio...'"
            [fullscreen]="false"
            [size]="'md'"
            [showBackdrop]="false">
          </app-loading-overlay>

          <!-- Formulario -->
          <form *ngIf="!isLoadingData" [formGroup]="espacioForm" class="px-2 md:px-8 space-y-6">

            <!-- Primera fila -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <app-input
                label="Nombre del Espacio"
                name="nombre"
                [required]="true"
                placeholder="Ej: Centro Comunitario La Esperanza"
                [control]="nombre"
                [disabled]="isFormLocked">
              </app-input>

              <app-input
                label="Teléfono"
                name="telefono"
                [required]="true"
                type="text"
                placeholder="Ej: 351-123-4567"
                [control]="telefono"
                [disabled]="isFormLocked">
              </app-input>
            </div>

            <!-- Segunda fila -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <app-select
                label="Tipo de Organización"
                name="tipoOrganizacion"
                [required]="true"
                [options]="tipoOrganizacionOpciones"
                placeholder="Selecciona el tipo"
                [control]="tipoOrganizacion"
                [disabled]="isFormLocked">
              </app-select>

              <app-input
                label="Encargado"
                name="encargado"
                placeholder="Nombre del responsable"
                [control]="encargado"
                [disabled]="isFormLocked">
              </app-input>
            </div>

            <!-- Tercera fila -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <app-input
                label="Dirección"
                name="direccion"
                placeholder="Calle, número, etc."
                [control]="direccion"
                [disabled]="isFormLocked">
              </app-input>

              <app-input
                label="Barrio"
                name="barrio"
                placeholder="Nombre del barrio"
                [control]="barrio"
                [disabled]="isFormLocked">
              </app-input>
            </div>

            <!-- Población vinculada -->
            <div class="space-y-4">
              <label class="block text-sm font-bold text-black">
                Población Vinculada
              </label>

              <!-- Chips de población seleccionada -->
              <div class="mb-4" *ngIf="poblacionVinculada.length > 0">
                <div class="flex flex-wrap gap-2">
                  <span *ngFor="let poblacion of poblacionVinculada.value"
                        class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                    {{ getPoblacionLabel(poblacion) }}
                    <button type="button"
                            *ngIf="!isFormLocked"
                            (click)="onPoblacionChange({target: {checked: false}}, poblacion)"
                            class="ml-2 text-blue-600 hover:text-blue-800">
                      <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                      </svg>
                    </button>
                  </span>
                </div>
              </div>

              <!-- Checkboxes para seleccionar población -->
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                <label *ngFor="let opcion of poblacionOpciones"
                       class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors"
                       [class.cursor-not-allowed]="isFormLocked"
                       [class.opacity-50]="isFormLocked">
                  <input type="checkbox"
                         [checked]="isPoblacionSelected(opcion.value)"
                         (change)="onPoblacionChange($event, opcion.value)"
                         [disabled]="isFormLocked"
                         class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 focus:ring-2">
                  <span class="ml-3 text-sm font-medium text-gray-700">{{ opcion.label }}</span>
                </label>
              </div>
            </div>

            <!-- Horarios -->
            <div>
                <app-input
              label="Días y Horarios de Atención"
              name="diasHorarios"
              placeholder="Ej: Lunes a Viernes: 9:00-18:00, Sábados: 9:00-13:00"
              [control]="diasHorarios"
              [disabled]="isFormLocked">
            </app-input>
            </div>

            <!-- Actividades -->
            <!-- <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-bold text-black mb-2">
                  Actividades Principales
                </label>
               <textarea
                    [formControl]="actividadesSecundarias"
                    rows="4"
                    placeholder="Describe las actividades secundarias o complementarias..."
                    class="text-area w-full px-3 py-2 text-sm border border-gray-300 rounded-lg outline-none 
                        focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition duration-200">
                </textarea>
              </div>

              <div>
                <label class="block text-sm font-bold text-black mb-2">
                  Actividades Secundarias
                </label>
                <textarea
                    [formControl]="actividadesSecundarias"
                    rows="4"
                    placeholder="Describe las actividades secundarias o complementarias..."
                    class="text-area w-full px-3 py-2 text-sm border border-gray-300 rounded-lg outline-none 
                        focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition duration-200">
                </textarea>
              </div>
            </div> -->

            <!-- Botones de acción -->
            <div *ngIf="!showActivitiesSection" class="flex flex-col sm:flex-row justify-end gap-4 pt-6 border-t border-gray-200">
              <app-button
                text="Cancelar"
                variant="outline"
                class="w-full sm:w-auto"
                (clicked)="onCancel()"
                [disabled]="isFormLocked">
              </app-button>
              <app-button
                text="Guardar Cambios"
                variant="primary"
                class="w-full sm:w-auto"
                [disabled]="espacioForm.invalid || isLoading || isFormLocked"
                (clicked)="onSave()">
              </app-button>
            </div>

          </form>
        </div>
      </div>

      <!-- Sección de Actividades -->
      @if(!isLoadingActivities){
        <div class="main-activities" *ngIf="showActivitiesSection">
        <div class="border-t border-gray-200 pt-8">
          <div class="flex justify-between items-center mb-1">
            <div class="flex items-center gap-3">
              <h2 class="text-xl font-bold  text-gray-600 tracking-wide mb-8" style="font-family: 'Poppins', sans-serif;">Actividades</h2>
            </div>
            <app-button
              (click)="abrirFormModal()"
              label="Nueva Actividad"
              variant="primary"
              size="medium">
            </app-button>
          </div>

          <!-- Tabla de actividades -->
          <div class="">
              
              <div class="p-6">
                <app-table
                  [columns]="columns"
                  [data]="tableData"
                  [filters]="filters"
                  [totalItems]="actividades.length"
                  [itemsPerPage]="10"
                  [currentPage]="1"
                  (onView)="onViewActivity($event)"
                  (onEdit)="onEditActivity($event)"
                  (onDelete)="onDeleteActivity($event)"
                  (onFilterChange)="onFilterChange($event)"
                  (onPageChange)="onPageChange($event)">
                </app-table>
              </div>
          </div>
        </div>
        <div class="flex flex-col sm:flex-row justify-end gap-4 pt-6 border-t border-gray-200">
                <app-button
                  text="Cancelar"
                  variant="outline"
                  class="w-full sm:w-auto"
                  (clicked)="onCancel()">
                </app-button>
                <app-button
                  text="Guardar Cambios"
                  variant="primary"
                  class="w-full sm:w-auto"
                  [disabled]="espacioForm.invalid || isLoading"
                  (clicked)="onSave()">
                </app-button>
              </div>
      </div>
      }
    </div>
  </div>

  <!-- Side Menu con Formulario de Actividad -->
  <app-side-menu
    [isOpen]="isFormOpen"
    [title]="sideMenuTitle"
    (closeEvent)="cerrarFormModal()">
    <app-activity-form
      [activityToEdit]="activityToEdit"
      (closeForm)="cerrarFormModal()"
      (activityCreated)="onActivityCreated($event)"
      (activityUpdated)="onActivityUpdated($event)">
    </app-activity-form>
  </app-side-menu>

  <!-- Modal de confirmación de eliminación -->
  <app-modal-confirmation
    [visible]="showDeleteModal"
    [message]="deleteModalMessage"
    type="danger"
    (cancel)="cancelarEliminacion()"
    (confirm)="confirmarEliminacion()">
  </app-modal-confirmation>

  <!-- Side Menu para detalles de actividad -->
  <app-side-menu
    [isOpen]="showDetailsModal"
    [title]="detailsModalTitle"
    (closeEvent)="cerrarDetailsModal()">
    <app-activity-details
      [activity]="activityToView"
      (closeDetails)="cerrarDetailsModal()"
      (editActivity)="onEditFromDetails($event)">
    </app-activity-details>
  </app-side-menu>
</div>
