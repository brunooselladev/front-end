<!-- Chat Header -->
<div class="chat-header">
  <div class="chat-header__content">
    <app-back-button [isBackButton]="true"></app-back-button>
    <!-- Chat Info -->
    <div class="chat-info">
      <h2 class="chat-title">Sala de chat: {{ nombrePaciente }}</h2>
      <div class="chat-meta">
        <span class="chat-participants">Participantes: {{ getParticipantesNombres() }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Messages Container -->
<div class="chat-messages" #messagesContainer>
  <div class="messages-list">
    <div class="day-messages-group" *ngFor="let dia of mensajesPorDia; trackBy: trackByFecha">
      <!-- Date Separator -->
      <div class="date-separator">
        <span class="date-text">{{ dia.fecha }}</span>
      </div>

      <!-- Messages for this day -->
      <div class="message-wrapper" *ngFor="let mensaje of dia.mensajes; trackBy: trackByMensajeId" [class.message-own]="mensaje.esMio">
        <div class="message-avatar" *ngIf="!mensaje.esMio">
          <span class="avatar-letter">{{ mensaje.emisorUsuario?.nombre?.charAt(0) || '?' }}</span>
        </div>

        <!-- Message Content -->
        <div class="message-content" [class.message-own-content]="mensaje.esMio">
          <div class="message-sender" *ngIf="!mensaje.esMio">
            {{ mensaje.emisorUsuario?.nombre || 'Usuario desconocido' }} - {{ getUserRoleText(mensaje.emisorUsuario?.role || '') }}
          </div>
          <div class="message-bubble">
            <p class="message-text">{{ mensaje.descripcion }}</p>
            <span class="message-time">{{ formatearHora(mensaje.hora) }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="empty-state" *ngIf="mensajesPorDia.length === 0">
      <div class="empty-icon">
        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
      </div>
      <h3 class="empty-title">No hay mensajes aún</h3>
      <p class="empty-description">Sé el primero en enviar un mensaje en esta conversación.</p>
    </div>
  </div>
</div>

<!-- Message Input -->
<div class="chat-input">
  <div class="input-container">
    <textarea
      #messageInput
      [(ngModel)]="nuevoMensaje"
      (keydown)="onKeyPress($event)"
      placeholder="Escribe un mensaje..."
      class="message-textarea"
      rows="1"
      [disabled]="loading"
      maxlength="500"></textarea>

    <button
      type="button"
      (click)="enviarMensaje()"
      [disabled]="!nuevoMensaje.trim() || loading"
      class="send-button"
      [class.loading]="loading">
      <svg *ngIf="loading" class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <svg *ngIf="!loading" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
      </svg>
    </button>
  </div>

  <div class="input-footer">
    <span class="character-count" [class.near-limit]="nuevoMensaje.length > 450">
      {{ nuevoMensaje.length }}/500
    </span>
  </div>
</div>
